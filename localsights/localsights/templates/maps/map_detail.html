{% extends 'base.html' %}
{% load static i18n %}

{% block title %}localsights{% endblock title %}

{% block css %}
    <!-- Latest compiled and minified Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

    <!-- Your stuff: Third-party CSS libraries go here -->
    <!-- This file stores project-specific CSS -->

    <link href="{% static 'css/project.css' %}" rel="stylesheet">
    <!-- Your specific CSS file for the maps page -->
    <link href="{% static 'css/maps.css' %}" rel="stylesheet">
{% endblock %}

{% block content %}

<script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>

<script>

    let map

    function initMap() {
        var directionsService = new google.maps.DirectionsService();
        var directionsRenderer = new google.maps.DirectionsRenderer();

        const map = new google.maps.Map(document.getElementById("map"), {
            center: { lat: 38.4496, lng: -78.8689 },
            zoom: 8,
            mapId: "8433f60590734a15",
        });
        directionsRenderer.setMap(map);
        calculateAndDisplayRoute(directionsService, directionsRenderer);
    }

    function calculateAndDisplayRoute(directionsService, directionsRenderer) {
        var waypts = [];
        
        var origin = JSON.parse('{{origin|safe}}')
        var waypoints = JSON.parse('{{way_points|safe}}')
        var dest = JSON.parse('{{dest|safe}}')

        
        for (let i = 0; i < waypoints.length; i++) {
            waypts.push({
                location: waypoints[i],
                stopover: true,
            });
        }
    
        console.log(origin)
        console.log(waypts)
        console.log(dest)
    
        
        directionsService
            .route({
                origin: origin,
                destination: dest,
                waypoints: waypts,
                optimizeWaypoints: true,
                travelMode: google.maps.TravelMode.DRIVING,
            })
            .then((response) => {
                console.log(response)
                directionsRenderer.setDirections(response);

        })
        .catch((e) => window.alert("Directions request failed due to " + status)); 
    }
       // console.log(myList)

    /*    const map = new Map(document.getElementById("map"), {
            center: { lat: 38.4496, lng: -78.8689 },
            zoom: 8,
            mapId: "8433f60590734a15",
        });
        
       // console.log(typeof locations)
       // console.log(locations)
       // console.log(typeof locations[0].lat)
       // console.log(locations[0].lat)
       // console.log(locations[1])
       // console.log(locations[2])

        
        locations.forEach(function (location) {
            console.log(location)
            console.log(location.lat)
            console.log(location.lng)

            const marker = new AdvancedMarkerElement({
            position: { lat: location.lat, lng: location.lng },
            map: map,
            title: location.name,
          }); 
        })
        }
    
    */
    window.initMap = initMap
</script>

<div class="pageholder">
    <div class="titleholder"> 
        <div class="title"> Your Map's Locations! </div> 
    </div>

    <div class="linkholder">
      <table id="ourtable3" class="myTable m-3">
        <thead>
            <tr>
                <th>Id</th>
                <th>Name</th>
                <th>Address</th>
                <th>Zipcode</th>
                <th>City</th>
                <th>Country</th>
                <th>Geocode link</th>
            </tr>
        </thead>

        <tbody>
            {% for location in map.locations.all %}
            <tr>
                <td> {{location.id}} </td>
                <td> {{location.name}} </td>
                <td> {{location.address}} </td>
                <td> {{location.zipcode}} </td>
                <td> {{location.city}} </td>
                <td> {{location.country}} </td>
                <td> <a href="{% url 'geocoding' location.id %}"> Geocode!</a> </td>
            </tr>
            {% endfor%}
        </tbody>        
      </table>
    </div>
    
    <div class="linkholder">
        <div class="mapholder" style="width: 100%; height: 300px;">
            <div id="map"></div>

            <script async
                src="https://maps.googleapis.com/maps/api/js?key={{key}}&loading=async&callback=initMap">
            </script>

            

        </div>
    </div>
</div>


{% endblock %}